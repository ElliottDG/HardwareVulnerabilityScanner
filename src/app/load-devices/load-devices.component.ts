import { Component, ViewChild } from '@angular/core';
import { WebHidService } from '../services/web-hid.service';
import { MatTable } from '@angular/material/table';
import { Router } from '@angular/router';

@Component({
  selector: 'app-load-devices',
  templateUrl: './load-devices.component.html',
  styleUrls: ['./load-devices.component.scss']
})
export class LoadDevicesComponent {

  dataSource: any[] = [];
  displayedColumns: string[] = ['deviceNumber', 'deviceName', 'vendorId', 'productId'];
  deviceNumber: number = 1;

  @ViewChild(MatTable) table!: MatTable<any>;

  constructor(private webHidService: WebHidService,
    private router: Router) { }

  loadDevices(): void {
    let addedDevices: number[] = [];
    this.webHidService.requestDevice().then((devices) => {
      if (devices) {
        for (let i = 0; i < devices.length; i++) {
          if (addedDevices.includes(devices[i].productId)) {
            continue;
          }
        const dataItem = {
          deviceNumber: this.deviceNumber,
          deviceName: devices[i].productName,
          vendorId: devices[i].vendorId,
          productId: devices[i].productId
        };
        // Add the dataItem to the dataSource array
        addedDevices.push(devices[i].productId);
        this.dataSource.push(dataItem);
        this.deviceNumber++;
        this.table.renderRows();
      }
      }
    });
  }

  clearDevices(): void {
    this.dataSource = [];
    this.deviceNumber = 1;
    this.table.renderRows();
  }

  toScanResults(): void {
    this.router.navigate(['/ScanResults'], { state: { data: this.dataSource } });
  }
}

